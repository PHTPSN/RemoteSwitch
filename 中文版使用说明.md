# Remote Switch

**不想在终于放下手机，准备进入美美进入梦乡时却还要爬上爬下梯子关灯？** 这个项目旨在使用 Android 应用程序通过蓝牙低功耗 (BLE) 远程控制物理开关。该系统使用 ESP32-C3 开发板来操作两个舵机，并具有省电深度睡眠功能。

## 功能特性

- **BLE Remote Control:** 使用标准 BLE 服务，通过 Android 应用程序安全地一键打开 (ON) 或关闭 (OFF) 开关。
- **Automatic Time Sync:** ESP32 的内部时钟与手机时间同步，以便管理睡眠计划。
- **Power Saving:** 在 3000mA 锂电池供电下，设备可以运行 1 到 2 个月。
  - 设备在非活动时间（例如，上午 10 点 - 晚上 9 点）进入深度睡眠模式以节省电池。在此期间，您将无法通过手机控制设备。但请不要担心，您可以按下 **ESP32 上的 RST** 按钮来清除时间储存。在从手机获取时间之前，设备不会进入深度睡眠模式，也不会在上次操作后的最初几分钟内进入。
  - 连接后，经过固定的一段时间，设备将自动与手机断开连接。
- **Persistent Bonding:** Android 应用程序会记住绑定的设备，从而无需每次都扫描，即使 **ESP32** 重置。但您可以通过 Android 应用程序上的 **Reset** 来解除与设备的绑定，或者在手机设置中手动执行此操作。

## 硬件设置

### 组件

- ESP32-C3 开发板（如 AirM2M_CORE_ESP32C3）
- 2x 微型舵机（如 SG90 180&deg;）
- 电源（如带 Type-C 端口的 LiPo 电池）
- 杜邦线、纳米胶等

### 连接方式

- **下方舵机**（控制 OFF）连接到 **GPIO 4**
- **上方舵机**（控制 ON）连接到 **GPIO 2**

注：这只是以开关在其顶部被按下时打开且舵机位于开关右侧的情况为例。您可以根据自己的需要，参考 [调整](#adjust) 中的内容，在 `firmware/Remote_Switch_ESP32.ino` 中调整一些细节。您也可以通过以下方式直接烧录：`esptool.py --port <serial_port> write_flash 0x1000 esp32c3.ino.bin`。

## 固件设置 (ESP32)

### 标准步骤

1. **前提条件：**
   - 安装 [Arduino IDE](https://www.arduino.cc/en/software)。
   - 将 ESP32 板支持添加到 Arduino IDE。按照此[指南](https://docs.espressif.com/projects/arduino-esp32/en/latest/installing.html)进行操作。选择合适的开发板。
2. **安装库：**
   - 打开库管理器 (`Sketch > Include Library > Manage Libraries...`)。
   - 安装 `ESP32Servo`。
3. **调整代码**
4. **烧录固件：**
   - 在 Arduino IDE 中打开 `firmware/esp32ce.ino`。
   - 选择正确的 COM 端口。
   - 单击 **Upload**。

### 调整 {#adjust}

以下是一些您可能会使用的常见设置 `firmware/Remote_Switch_ESP32.ino` 的位置：

1. **舵机引脚：**

```cpp
const long SLEEP_DURATION = 11 * 3600; // 11 hours
const long SLEEP_WINDOW_START = 10 * 3600; // 10am
const long SLEEP_WINDOW_END = 21 * 3600; // 9pm
```

1. **睡眠周期：**

```cpp
const long SLEEP_DURATION = 11 * 3600; // 11 hours
const long SLEEP_WINDOW_START = 10 * 3600; // 10am
const long SLEEP_WINDOW_END = 21 * 3600; // 9pm
```

1. **自动断开连接时间：**

```cpp
const long DISCONNECT_TIME = 3 * 60 * 1000; // 3 mins
```

1. **旋转角度：** 第一个角度是旋转角度，第二个角度是恢复位置角度。

```cpp
if(value == "1") {
    Serial.println("Received '1'");
    activateServo(SERVO_B_PIN, servoB, 0, 30); // Turn on, the upper servo rotate 30°
} 
else if(value == "0") {
    Serial.println("Received '0'");
    activateServo(SERVO_A_PIN, servoA, 30, 0);  // Turn off, the lower servo rotate 30°
}
```

## 如何使用该应用程序

1. **Scan**: 首次使用该应用程序时，请允许权限。点击 **Scan**。应用将查找名为“Remote Switch”的 BLE 设备。如果找不到您的设备，请尝试在系统设置中手动启用位置权限。
1. **Bond:** 该应用程序将自动启动绑定请求。接受请求。绑定后，应用程序将记住该设备。我们设置了一个较大的广播间隔以省电。如果您可以找到设备但无法与其绑定，您可以点击 **Scan** 再次尝试绑定。
1. **Connect:** 点击 **Connect**。 该应用程序将建立连接并自动将时间与设备同步。
1. **Control:** 状态为“Connected”后，使用 **ON** 和 **OFF** 按钮来控制开关。为了省电，请尽量记得在使用后点击 **Disconnect** ，尽管设备会在几分钟后自动执行此操作。
1. **Reset:** 点击 **Reset** 以解除与设备的绑定。重置后，您将需要再次扫描。但它不会删除权限。
1. **Other Instructions:** 如果该应用程序因 `Need Permission` 而停止，请手动允许所有蓝牙权限。 当另一部手机连接到该设备时，您将无法找到或连接到该设备。

备注：根据官方说明，Android 10+ 不需要位置权限，但我的 Android 11 和 13 需要，我花了我整整 2 天的才发现扫描不到设备是因为这个！（啊这）
